@inherits LayoutComponentBase
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudRTLProvider RightToLeft="true">
    <MudLayout>
        <MudAppBar Elevation="0" Color="Color.Transparent" Fixed="true" Class="border-b mud-theme-border-color backdrop-blur">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Primary" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
            
            <!-- Breadcrumbs / Title Area -->
            <div class="d-flex flex-column ml-4">
                 <MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="pa-0 f-12 text-muted" />
                 <MudText Typo="Typo.h6" Class="mud-text-primary" Style="font-weight: 700;">نظام إدارة التدريب</MudText>
            </div>

            <MudSpacer />
            
            <!-- Top Actions -->
            <MudIconButton Icon="@Icons.Material.Filled.NotificationsNone" Color="Color.Default" />
            <MudAvatar Class="course-avatar ml-3" Color="Color.Primary" Variant="Variant.Outlined">ع</MudAvatar>
            <div class="d-flex flex-column mr-2">
                <MudText Typo="Typo.caption" Class="mud-text-primary" Style="font-weight: bold;">المدير العام</MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">الموارد البشرية</MudText>
            </div>
        </MudAppBar>

        <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="0" Breakpoint="Breakpoint.Md" Class="border-e mud-theme-border-color">
            <MudDrawerHeader Class="d-flex align-center justify-center py-4">
                 <MudIcon Icon="@Icons.Material.Filled.Polymer" Color="Color.Primary" Size="Size.Large" Class="mr-2"/>
                 <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 800;">Astrea System</MudText>
            </MudDrawerHeader>
            <NavMenu />
            
            <!-- Bottom Toggle -->
            <div class="pa-4 mt-auto">
                 <MudPaper Elevation="0" Outlined="true" Class="pa-1 d-flex rounded-pill align-center justify-center">
                     <MudIconButton Icon="@Icons.Material.Filled.WbSunny" Color="@(_isDarkMode ? Color.Default : Color.Primary)" OnClick="@(() => _isDarkMode = false)" Size="Size.Small" />
                     <MudIconButton Icon="@Icons.Material.Filled.DarkMode" Color="@(_isDarkMode ? Color.Primary : Color.Default)" OnClick="@(() => _isDarkMode = true)" Size="Size.Small" />
                 </MudPaper>
            </div>
        </MudDrawer>

        <MudMainContent Class="pa-6 pt-20">
            @Body
        </MudMainContent>
    </MudLayout>
</MudRTLProvider>

<style>
    /* Global Overrides for Premium Feel */
    
    body, .mud-typography, .mud-input-control {
        font-family: 'Tajawal', 'Segoe UI', 'Helvetica', 'Arial', sans-serif !important;
    }

    /* Light Mode Specific Overrides */
    .mud-theme-light body {
         background-color: #F8F9FB;
    }
    
    .mud-theme-light .mud-appbar {
        background-color: rgba(255,255,255,0.8);
        backdrop-filter: blur(10px);
    }
    
    .mud-theme-light .mud-drawer {
        background-color: #FFFFFF;
    }

    /* Dark Mode Specific Overrides */
    .mud-theme-dark .mud-appbar {
        backdrop-filter: blur(10px);
    }
    
    /* Nav Link Styling match Screenshot */
    .mud-nav-link {
        color: #6B7280 !important;
        border-radius: 8px;
        margin: 4px 12px;
    }
    .mud-nav-link:hover {
        background-color: #F3F4F6 !important;
        color: #111827 !important;
    }
    .mud-nav-link.active {
        background-color: #F5F3FF !important; /* Light Purple bg */
        color: #594AE2 !important; /* Purple text */
        font-weight: 600;
    }
    .mud-nav-link.active .mud-nav-link-icon {
        color: #594AE2 !important;
    }
</style>

@using TrainingSystem.Client.Services
@inject NavigationManager Navigation

@code {
    bool _drawerOpen = true;
    bool _isDarkMode = false;
    
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += LocationChanged;
        UpdateBreadcrumbs();
    }

    private void LocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateBreadcrumbs();
        StateHasChanged();
    }

    private void UpdateBreadcrumbs()
    {
        var path = new Uri(Navigation.Uri).AbsolutePath;
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("الرئيسية", href: "/")
        };

        if (path != "/")
        {
            var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
            var currentPath = "";
            
            foreach (var segment in segments)
            {
                currentPath += $"/{segment}";
                var title = GetTitleForSegment(segment);
                var isLast = segment == segments.Last();
                _breadcrumbs.Add(new BreadcrumbItem(title, href: isLast ? null : currentPath, disabled: isLast));
            }
        }
    }

    private string GetTitleForSegment(string segment)
    {
        return segment.ToLower() switch
        {
            "employees" => "الموظفين",
            "attendance" => "سجل الحضور",
            "courses" => "الدورات-التدريبية",
            "edit" => "تعديل",
            "create" => "إضافة",
             // Add mappings as needed, default to segment
            _ => segment
        };
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= LocationChanged;
    }

    MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2563EB", // Blue
            Secondary = "#FF4081",
            AppbarBackground = "#FFFFFF",
            Background = "#F8F9FB",
            DrawerBackground = "#FFFFFF",
            TextPrimary = "#111827",
            TextSecondary = "#6B7280",
            LinesInputs = "#E5E7EB",
            TableLines = "#F3F4F6",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#3B82F6", // Lighter Blue for Dark Mode
            Secondary = "#FF4081",
            AppbarBackground = "#1E1E2D00", // Transparent
            Background = "#151521",
            DrawerBackground = "#1E1E2D",
            Surface = "#1E1E2D",
            TextPrimary = "#FFFFFF",
            TextSecondary = "#92929F",
            LinesInputs = "#2B2B40",
            TableLines = "#2B2B40",
            ActionDefault = "#ADADB8",
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "12px",
            DrawerWidthLeft = "260px",
            DrawerWidthRight = "260px"
        }
    };

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
}
